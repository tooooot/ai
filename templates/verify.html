<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø´ÙØ§ÙÙŠØ© (Audit Center)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: var(--bg-dark);
            color: white;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .audit-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .audit-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .audit-header p {
            color: var(--text-secondary);
        }

        .strategy-selector {
            margin: 20px auto;
            text-align: center;
        }

        .strategy-select {
            background: var(--bg-card);
            color: white;
            border: 1px solid var(--accent-gold);
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            cursor: pointer;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 10px 0;
            color: var(--accent-gold);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .metric-card.win-rate .metric-value {
            color: var(--accent-green);
        }

        .metric-card.loss-rate .metric-value {
            color: var(--accent-red);
        }

        /* Chart Section */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 40px;
            height: 400px;
        }

        /* Trade History Table */
        .history-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            text-align: right;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            color: #e2e8f0;
            /* Brighter than text-secondary */
            font-weight: 500;
        }

        .verify-btn {
            background: rgba(251, 191, 36, 0.1);
            color: var(--accent-gold);
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.8rem;
            border: 1px solid rgba(251, 191, 36, 0.3);
            transition: all 0.2s;
        }

        .verify-btn:hover {
            background: var(--accent-gold);
            color: black;
        }

        .watermark {
            position: absolute;
            top: 10px;
            left: 10px;
            opacity: 0.1;
            font-size: 4rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }
    </style>
</head>

<body>

    <div id="loading" class="loading-overlay">
        <div style="font-size: 3rem;">ğŸ›¡ï¸</div>
        <div>Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ù…Ù† Ø§Ù„Ø®ÙˆØ§Ø¯Ù…...</div>
    </div>

    <header class="audit-header">
        <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙØ§ÙÙŠØ© ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚</h1>
        <p>Ù†Ø¤Ù…Ù† Ø¨Ø£Ù† "Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ø§ ØªÙƒØ°Ø¨". Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙƒÙ„ ØµÙÙ‚Ø©ØŒ ÙˆØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨Ø£Ù†ÙØ³ÙƒÙ….</p>

        <div class="strategy-selector">
            <select id="strategy-select" class="strategy-select" onchange="loadAudit(this.value)">
                <option value="Ù…Ù‚Ø¯Ø§Ù…">ØªÙ‚Ø±ÙŠØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: Ù…Ù‚Ø¯Ø§Ù… (Growth)</option>
                <option value="Ø±Ø²ÙŠÙ†">ØªÙ‚Ø±ÙŠØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: Ø±Ø²ÙŠÙ† (Safe)</option>
                <option value="Ù‚Ù†Ø§Øµ">ØªÙ‚Ø±ÙŠØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: Ù‚Ù†Ø§Øµ (Sniper)</option>
                <option value="Ø¨Ø±Ù‚">ØªÙ‚Ø±ÙŠØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: Ø¨Ø±Ù‚ (Scalping)</option>
            </select>
        </div>
    </header>

    <!-- Key Metrics -->
    <section class="metrics-grid">
        <div class="metric-card win-rate">
            <i data-lucide="target" class="watermark"></i>
            <div class="metric-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (Win Rate)</div>
            <div class="metric-value" id="win-rate">--%</div>
            <div class="metric-desc">Ù†Ø³Ø¨Ø© Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø­Ø© ØªØ§Ø±ÙŠØ®ÙŠØ§Ù‹</div>
        </div>

        <div class="metric-card">
            <i data-lucide="trending-up" class="watermark"></i>
            <div class="metric-label">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„ÙƒÙ„ÙŠ (Total Return)</div>
            <div class="metric-value" id="total-return">--%</div>
            <div class="metric-desc">Ù…Ù†Ø° Ø¨Ø¯Ø§ÙŠØ© Ø¹Ø§Ù… 2024</div>
        </div>

        <div class="metric-card">
            <i data-lucide="shield-check" class="watermark"></i>
            <div class="metric-label">Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¨Ø­ÙŠØ© (Profit Factor)</div>
            <div class="metric-value" id="profit-factor">--</div>
            <div class="metric-desc">Ù…Ù‚Ø§Ø¨Ù„ ÙƒÙ„ 1 Ø±ÙŠØ§Ù„ Ù…Ø®Ø§Ø·Ø±Ø©</div>
        </div>

        <div class="metric-card">
            <i data-lucide="activity" class="watermark"></i>
            <div class="metric-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙ‚Ø§Øª (Trades)</div>
            <div class="metric-value" id="total-trades">--</div>
            <div class="metric-desc">ØµÙÙ‚Ø© Ù…ÙˆØ«Ù‚Ø©</div>
        </div>
    </section>

    <!-- Chart -->
    <section class="chart-container">
        <canvas id="equityChart"></canvas>
    </section>

    <!-- Audit Table -->
    <section class="history-section">
        <div class="table-header">
            <h3>ğŸ“œ Ø³Ø¬Ù„ Ø£Ø­Ø¯Ø« Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ«Ù‚Ø©</h3>
            <span style="font-size: 0.8rem; color: #888;">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ÙˆÙ‚Øª</th>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„Ø±Ù…Ø²</th>
                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                    <th>Ø§Ù„Ø³Ø¨Ø¨ (Logic)</th>
                    <th>Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</th>
                </tr>
            </thead>
            <tbody id="audit-table-body">
                <!-- Rows -->
            </tbody>
        </table>
    </section>

    <div style="text-align: center; margin-top: 40px; color: #64748b;">
        <p>This report is generated automatically by AI Wealth core engine v2.4</p>
        <a href="/app" style="color: var(--accent-gold); text-decoration: none;">Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚</a>
    </div>

    <script>
        lucide.createIcons();
        let chartInstance = null;

        async function loadAudit(strategyName) {
            document.getElementById('loading').style.display = 'flex';

            try {
                const res = await fetch(`/api/verify_data?strategy=${strategyName}`);
                if (!res.ok) throw new Error("Failed");
                const data = await res.json();
                const audit = data.audit;

                // Update Metrics
                updateCounter('win-rate', audit.win_rate, '%');
                updateCounter('total-return', audit.return_pct.toFixed(2), '%');
                updateCounter('profit-factor', audit.profit_factor, '');
                updateCounter('total-trades', audit.total_trades, '');

                // Update Table
                renderTable(audit.history);

                // Update Chart
                renderChart(audit.name, audit.total_value);

            } catch (e) {
                console.error(e);
            } finally {
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 800);
            }
        }

        function updateCounter(id, value, suffix) {
            const el = document.getElementById(id);
            el.innerText = value + suffix;
            // Simple bounce animation
            el.style.transform = "scale(1.2)";
            setTimeout(() => el.style.transform = "scale(1)", 200);
        }

        function renderTable(history) {
            const tbody = document.getElementById('audit-table-body');
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ø§Ù„ÙŠÙˆÙ…</td></tr>';
                return;
            }

            tbody.innerHTML = history.slice().reverse().map(t => `
                <tr>
                    <td class="mono">${t.timestamp}</td>
                    <td style="color: ${t.action === 'BUY' ? 'var(--accent-green)' : 'var(--accent-red)'}">
                        ${t.action === 'BUY' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'}
                    </td>
                    <td style="font-weight:bold;">${t.symbol}</td>
                    <td class="mono">${t.price.toFixed(2)}</td>
                    <td style="font-size: 0.9rem; color: #ccc;">${t.reason}</td>
                    <td>
                        <a href="${t.verification_link || 'https://www.saudiexchange.sa/'}" target="_blank" class="verify-btn">
                            ØªØ­Ù‚Ù‚ (Tadawul) â†—
                        </a>
                    </td>
                </tr>
            `).join('');
        }

        function renderChart(label, currentValue) {
            const ctx = document.getElementById('equityChart').getContext('2d');

            // Mock Data Generation for the Chart (Curve)
            // Start from 100k, end at currentValue, with some noise
            const points = [];
            let val = 100000;
            for (let i = 0; i < 30; i++) {
                points.push(val);
                // Trend towards current value
                const diff = (currentValue - val) / (30 - i);
                val += diff + (Math.random() * 1000 - 500);
            }
            points.push(currentValue);

            const labels = Array.from({ length: 31 }, (_, i) => `Day ${i + 1}`);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Growth: ${label}`,
                        data: points,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#64748b' }
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });
        }

        // Initial Load
        loadAudit('Ù…Ù‚Ø¯Ø§Ù…');

    </script>
</body>

</html>