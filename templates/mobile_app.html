<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Private Wealth</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Extra Tweaks for App Mode */
        .strategy-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 10px 20px;
            scrollbar-width: none;
            /* Hide scrollbar */
        }

        .strategy-scroll::-webkit-scrollbar {
            display: none;
        }

        .st-pill {
            background: var(--bg-card);
            padding: 10px 20px;
            border-radius: 12px;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .st-pill.active {
            background: var(--accent-gold);
            color: #0b1120;
            border-color: var(--accent-gold);
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
    </style>
</head>

<body class="bank-theme app-mode">

    <!-- App Container -->
    <div class="app-container">

        <!-- Premium Header -->
        <header class="app-header">
            <div class="user-info">
                <div class="avatar">AI</div>
                <div>
                    <span class="greeting">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</span>
                    <span class="status">Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ù…ØªØµÙ„Ø©</span>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="icon-btn" onclick="window.location.href='/verify'">ğŸ›¡ï¸</button>
                <button class="icon-btn" onclick="openChat()">ğŸ’¬</button>
            </div>
        </header>

        <!-- Balance Card -->
        <div class="balance-card">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</div>
            <div class="amount" id="cash-display">-- SAR</div>
            <div class="change positive">
                <i data-lucide="trending-up"></i>
                <span>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ù‚ØªÙ†Ø§Øµ</span>
            </div>
        </div>

        <!-- Strategy Selector -->
        <div class="section-header">
            <h3>ğŸ¤– Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</h3>
        </div>
        <div class="strategy-scroll" id="strategy-selector">
            <!-- Pills Injected Here -->
        </div>

        <!-- Transactions Feed -->
        <div class="section-header" style="margin-top:20px;">
            <h3>Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø­ÙŠØ©</h3>
            <a href="#" class="see-all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
        </div>

        <div class="feed-wrapper" style="margin: 0 20px 80px; height:auto; min-height:300px;">
            <div class="transactions-list" id="content-area">
                <div style="text-align:center; padding:20px; color:#666;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©...</div>
            </div>
        </div>

        <!-- Floating Action Button (Voice/Chat) -->
        <button class="fab-chat" onclick="openChat()">
            <i data-lucide="mic"></i>
            <span>ØªØ­Ø¯Ø« Ù…Ø¹ Ø¹ÙˆØ§Ø·Ù</span>
        </button>

    </div>

    <!-- Chat Modal (Hidden by Default) -->
    <div id="chat-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; flex-direction:column; justify-content:flex-end;">
        <div
            style="background:var(--bg-card); height:85%; width:100%; border-radius:20px 20px 0 0; display:flex; flex-direction:column; max-width:480px; margin:0 auto;">
            <div
                style="padding:20px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:white;">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h3>
                <button onclick="testVoice()"
                    style="background:#334155; color:var(--accent-gold); border:none; padding:5px 10px; border-radius:5px; font-size:0.8rem;">ğŸ”Š
                    Test Voice</button>
                <button onclick="document.getElementById('chat-modal').style.display='none'"
                    style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
            </div>
            <div id="chat-history" style="flex:1; overflow-y:auto; padding:20px;"></div>
            <div style="padding:20px; border-top:1px solid #333; display:flex; gap:10px;">
                <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."
                    style="flex:1; padding:12px; border-radius:10px; border:none; background:#0f172a; color:white;">
                <button onclick="sendMessage()"
                    style="background:var(--accent-green); color:black; border:none; padding:0 20px; border-radius:10px; font-weight:bold;">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const strategies = [
            "Ø±Ø²ÙŠÙ†", "Ù…Ù‚Ø¯Ø§Ù…", "Ø­ØµØ§Ø¯",
            "Ø¨Ø±Ù‚", "Ù‚Ù†Ø§Øµ", "Ù…ÙˆØ¬",
            "Ù…Ù‚ØªØ­Ù…", "Ø¬ÙˆØ§Ù„", "Ø¹ÙˆØ§Ø·Ù", "Ù…Ø­Ø¸ÙˆØ¸"
        ];
        let currentStrategy = "Ø¹ÙˆØ§Ø·Ù";

        // Render Selector
        function renderSelector() {
            const container = document.getElementById('strategy-selector');
            container.innerHTML = strategies.map(s => `
                <div class="st-pill ${s === currentStrategy ? 'active' : ''}" onclick="loadStrategy('${s}')">
                    ${s}
                </div>
            `).join('');
        }

        async function loadStrategy(name) {
            currentStrategy = name;
            renderSelector();

            const container = document.getElementById('content-area');
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;"> Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>';

            // UPDATE FAB BUTTON TEXT
            const fabText = document.querySelector('.fab-chat span');
            if (fabText) fabText.innerText = `ØªØ­Ø¯Ø« Ù…Ø¹ ${name}`;

            try {
                const res = await fetch(`/api/portfolio/${encodeURIComponent(name)}`);
                const data = await res.json();

                // Update Cash
                const cashEl = document.getElementById('cash-display');
                if (cashEl) cashEl.innerText = data.cash.toFixed(2) + " SAR";

                // Render Trades
                if (data.history && data.history.length > 0) {
                    container.innerHTML = data.history.slice().reverse().map(t => {
                        return `
                        <div class="trx-item ${t.action === 'BUY' ? 'buy' : 'sell'}" style="margin-bottom:10px; background:rgba(255,255,255,0.05); padding:10px;">
                            <div class="trx-details" style="flex-direction:column; gap:5px;">
                                <div style="display:flex; justify-content:space-between;">
                                    <span class="strategy-tag ${t.action === 'BUY' ? 'green' : 'red'}">${t.action}</span>
                                    <span class="symbol-text">${t.symbol}</span>
                                    <span class="trx-price">${t.price.toFixed(2)}</span>
                                </div>
                                <div style="font-size:0.85rem; color:#ccc;">${t.reason}</div>
                                ${t.goals ? `
                                <div style="display:flex; gap:10px; font-size:0.75rem; color:#888; margin-top:5px;">
                                    <span>ğŸ¯ ${t.goals.target_price}</span>
                                    <span>ğŸ›‘ ${t.goals.stop_loss}</span>
                                </div>` : ''}
                            </div>
                        </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©.</div>';
                }

            } catch (e) {
                container.innerHTML = '<div style="color:red; text-align:center;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>';
            }
        }

        // --- Voice & Chat ---
        function openChat() { document.getElementById('chat-modal').style.display = 'flex'; }

        async function sendMessage() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value;
            if (!txt) return;
            const hist = document.getElementById('chat-history');

            hist.innerHTML += `<div style="text-align:right; margin-bottom:10px;"><span style="background:#334155; padding:8px 12px; border-radius:15px 15px 0 15px; display:inline-block;">${txt}</span></div>`;
            inp.value = '';

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ persona: currentStrategy, message: txt })
                });
                const d = await res.json();
                hist.innerHTML += `<div style="text-align:left; margin-bottom:10px;"><span style="background:var(--accent-green); color:black; padding:8px 12px; border-radius:15px 15px 15px 0; display:inline-block;">${d.response}</span></div>`;
                speak(d.response, currentStrategy);
            } catch (e) { }
        }

        function testVoice() {
            const v = speak("Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ø£Ù†Ø§ " + currentStrategy + ". Ù‡Ù„ ØªØ³Ù…Ø¹Ù†ÙŠ Ø¨ÙˆØ¶ÙˆØ­ØŸ", currentStrategy);
            if (v && v.name) alert("Voice: " + v.name);
            else alert("Using Default Voice (check pitch)");
        }

        function speak(text, persona) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ar-SA';

            // Get voices
            let voices = window.speechSynthesis.getVoices();
            // Retry if empty
            if (voices.length === 0) {
                window.speechSynthesis.onvoiceschanged = () => {
                    voices = window.speechSynthesis.getVoices();
                    // retry speak? (simplified for now)
                };
            }

            let v = null;

            // LOGIC FOR AWATIF (FEMALE)
            if (persona && persona.includes("Ø¹ÙˆØ§Ø·Ù")) {
                u.pitch = 1.6; // Higher pitch to force 'female-like' tone if voice missing
                u.rate = 1.1;

                // Try to find specific female voice
                v = voices.find(vo =>
                    vo.name.includes("Hoda") ||
                    vo.name.includes("Laila") ||
                    vo.name.includes("Zaira") ||
                    vo.name.includes("Muna")
                );
            } else {
                // DEFAULT MALE
                u.pitch = 0.9;
                u.rate = 1.0;
            }

            if (v) {
                u.voice = v;
                console.log("Selected Voice:", v.name);
            } else {
                console.log("No specific voice found, using default with pitch:", u.pitch);
            }

            window.speechSynthesis.speak(u);
            return v;
        }

        window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();

        // Init
        renderSelector();
        loadStrategy(currentStrategy);

    </script>
</body>

</html>