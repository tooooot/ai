<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Private Wealth</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bank-theme app-mode">

    <!-- App Container -->
    <div class="app-container">

        <!-- ================== VIEW 1: ONBOARDING ================== -->
        <!-- User lands here if not subscribed -->
        <div id="view-onboarding" class="view-section active">
            <div class="onboarding-slide">
                <div class="slide-icon">๐ง ๐ ๐ค</div>
                <h1 class="main-title">ููุงุฐุง ุชุฎุณุฑ ูู ุงูุณููุ</h1>
                <p style="color:var(--text-secondary); line-height:1.6;">
                    ุงูุฅูุณุงู ูุชุฑุฏุฏุ ูุฎุงูุ ููุชุนุจ.<br>
                    ุงูุฃุณูุงู ูุง ุชุฑุญู ุงูุนูุงุทู.
                </p>

                <div class="contrast-box">
                    <div class="vs-item vs-brain">
                        <i data-lucide="frown" style="margin-bottom:5px;"></i><br>
                        ูุฑุงุฑุงุช ุนุงุทููุฉ
                    </div>
                    <div style="font-weight:bold; color:#555;">VS</div>
                    <div class="vs-item vs-bot">
                        <i data-lucide="cpu" style="margin-bottom:5px;"></i><br>
                        ุจูุงูุงุช ุตุงููุฉ
                    </div>
                </div>

                <div class="contrast-box">
                    <div class="vs-item vs-brain">
                        <i data-lucide="clock" style="margin-bottom:5px;"></i><br>
                        ููู ูุฑุงุญุฉ
                    </div>
                    <div style="font-weight:bold; color:#555;">VS</div>
                    <div class="vs-item vs-bot">
                        <i data-lucide="zap" style="margin-bottom:5px;"></i><br>
                        24/7 ุงูุชูุงุต
                    </div>
                </div>

                <button class="bank-btn" onclick="switchView('marketplace')" style="width:100%; margin-top:20px;">
                    ุงูุชุดู ุงูุฑูุจูุชุงุช ๐
                </button>
            </div>
        </div>

        <!-- ================== VIEW 2: MARKETPLACE ================== -->
        <!-- User chooses a bot -->
        <div id="view-marketplace" class="view-section">
            <header class="app-header" style="background:transparent;">
                <h2 style="color:white; margin:0;">ุงุฎุชุฑ ุนููู ุงูุฐูู</h2>
                <button class="icon-btn" onclick="switchView('onboarding')">โฉ๏ธ</button>
            </header>

            <div class="market-grid">
                <!-- Bot 1: Sayyad -->
                <div class="bot-card-pro featured">
                    <div class="bot-card-header">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="avatar" style="background:var(--accent-gold); color:black;">ุต</div>
                            <div>
                                <div style="font-weight:bold; color:white;">ุฑูุจูุช ุตูุงุฏ</div>
                                <div style="font-size:0.7rem; color:var(--accent-gold);">ุงูุฃูุซุฑ ุดุนุจูุฉ</div>
                            </div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-weight:900; color:var(--accent-green); font-size:1.2rem;">+13%</div>
                            <div style="font-size:0.6rem; color:#888;">ุนุงุฆุฏ ุดูุฑู</div>
                        </div>
                    </div>
                    <p style="font-size:0.8rem; color:#ccc; margin-bottom:15px;">
                        ูุชุฎุตุต ูู ุงูุชูุงุต ุงููุฑุต ุงูุณุฑูุนุฉ ูู ุงูุณูู ุงูุณุนูุฏู. ูุนุชูุฏ ุนูู ุงูุชุญููู ุงูููู ุงููุญุธู.
                    </p>
                    <div class="bot-stats-row">
                        <div style="text-align:center;">
                            <div style="font-size:0.9rem;">92%</div>
                            <div style="font-size:0.6rem; color:#888;">ุฏูุฉ</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:0.9rem;">Medium</div>
                            <div style="font-size:0.6rem; color:#888;">ูุฎุงุทุฑุฉ</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:0.9rem;">24/7</div>
                            <div style="font-size:0.6rem; color:#888;">ุนูู</div>
                        </div>
                    </div>
                    <button class="subscribe-btn" onclick="subscribe('ุตูุงุฏ')">ุงุดุชุฑุงู (ุงุจุฏุฃ ุงูุฑุญูุฉ)</button>
                </div>

                <!-- Bot 2: Meqdam -->
                <div class="bot-card-pro">
                    <div class="bot-card-header">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="avatar" style="background:#ef4444; color:white;">ู</div>
                            <div>
                                <div style="font-weight:bold; color:white;">ุฑูุจูุช ููุฏุงู</div>
                                <div style="font-size:0.7rem; color:#ef4444;">ุนุงูู ุงููุฎุงุทุฑ</div>
                            </div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-weight:900; color:var(--accent-green); font-size:1.2rem;">+22%</div>
                            <div style="font-size:0.6rem; color:#888;">ุนุงุฆุฏ ุดูุฑู</div>
                        </div>
                    </div>
                    <p style="font-size:0.8rem; color:#ccc; margin-bottom:15px;">
                        ุฌุณูุฑุ ูุง ูุฎุดู ุงูุชููุจุงุช. ูุฏุฎู ูู ุตููุงุช ุฐุงุช ุนูุงุฆุฏ ุนุงููุฉ ููุฎุงุทุฑุฉ ูุฏุฑูุณุฉ.
                    </p>
                    <button class="subscribe-btn" style="background:#334155; color:white;"
                        onclick="subscribe('ููุฏุงู')">ุงุดุชุฑุงู</button>
                </div>
            </div>
        </div>

        <!-- ================== VIEW 3: DASHBOARD ================== -->
        <!-- Post-Subscription View -->
        <div id="view-dashboard" class="view-section">

            <!-- Insight Bubble Container -->
            <div id="insight-container"></div>

            <header class="app-header">
                <div class="user-info">
                    <div class="avatar" id="dash-avatar">AI</div>
                    <div>
                        <span class="greeting">ูุญูุธุฉ ูุดุทุฉ</span>
                        <span class="status" id="dash-status">ูุชุตู ุจู --</span>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <!-- Explain Toggle -->
                    <button class="icon-btn" id="explain-toggle" onclick="toggleExplain()"
                        style="color:var(--text-muted);">
                        <i data-lucide="lightbulb"></i>
                    </button>
                    <button class="icon-btn" onclick="window.location.href='/verify'">๐ก๏ธ</button>
                </div>
            </header>

            <div class="balance-card">
                <div class="label">ุตุงูู ูููุฉ ุงูุฃุตูู</div>
                <div class="amount" id="cash-display">10,000 SAR</div>
                <div class="change positive">
                    <i data-lucide="activity"></i>
                    <span>ูุนูู ุงูุขู ูู ุงูุณูู...</span>
                </div>
            </div>

            <div class="section-header">
                <h3>๐ ุงููุฑุงุฑุงุช ุงูุญูุฉ</h3>
                <span class="status" style="font-size:0.7rem;">ุชุญุฏูุซ ูุญุธู</span>
            </div>

            <div class="feed-wrapper" style="margin: 0 20px 80px; height:auto; min-height:400px; padding-bottom:100px;">
                <div class="transactions-list" id="content-area">
                    <!-- Trades injected here -->
                </div>
            </div>

            <!-- Floating Action Button -->
            <button class="fab-chat" onclick="openChat()">
                <i data-lucide="mic"></i>
                <span>ุงุณุฃู ุงูุฑูุจูุช</span>
            </button>
        </div>

    </div>

    <!-- Chat Overlay (Same as before) -->
    <div id="chat-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; flex-direction:column; justify-content:flex-end;">
        <div
            style="background:var(--bg-card); height:85%; width:100%; border-radius:20px 20px 0 0; display:flex; flex-direction:column; max-width:480px; margin:0 auto;">
            <div
                style="padding:20px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:white;">ุงููุณุงุนุฏ ุงูุฐูู</h3>
                <button onclick="document.getElementById('chat-modal').style.display='none'"
                    style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
            </div>
            <div id="chat-history" style="flex:1; overflow-y:auto; padding:20px;"></div>
            <div style="padding:20px; border-top:1px solid #333; display:flex; gap:10px;">
                <input type="text" id="chat-input" placeholder="ุงูุชุจ ุฑุณุงูุชู..."
                    style="flex:1; padding:12px; border-radius:10px; border:none; background:#0f172a; color:white;">
                <button onclick="sendMessage()"
                    style="background:var(--accent-green); color:black; border:none; padding:0 20px; border-radius:10px; font-weight:bold;">ุฅุฑุณุงู</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let currentBot = null;
        let explainMode = false;

        // View Switching Logic
        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => {
                    if (!el.classList.contains('active')) el.style.display = 'none';
                }, 500);
            });

            const target = document.getElementById('view-' + viewName);
            target.style.display = 'block';
            setTimeout(() => target.classList.add('active'), 50);
        }

        // Subscription Logic
        function subscribe(botName) {
            alert(`ูุจุฑูู! ุชู ุฑุจุท ูุญูุธุชู ูุน ุงูุฑูุจูุช ${botName} ๐`);
            currentBot = botName;

            // Setup Dashboard
            document.getElementById('dash-avatar').innerText = botName[0];
            document.getElementById('dash-status').innerText = `ูุชุตู ุจู ${botName}`;
            document.querySelector('.fab-chat span').innerText = `ุงุณุฃู ${botName}`;

            switchView('dashboard');
            loadStrategy(botName); // Load data

            // Auto-enable explanation for 10 seconds as demo
            toggleExplain();
            setTimeout(() => {
                showInsight("ูุฑุญุจุงู ุจู! ุณุฃููู ุงูุขู ุจุชุญููู 50 ุดุฑูุฉ ูู ุงูุณูู ุงูุณุนูุฏู. ุณุฃุฎุจุฑู ุจูู ูุฑุงุฑ ุฃุชุฎุฐู.");
            }, 1000);
        }

        // Toggle Insight Notifications
        function toggleExplain() {
            explainMode = !explainMode;
            const btn = document.getElementById('explain-toggle');
            if (explainMode) {
                btn.style.color = 'var(--accent-gold)';
                alert("ุชู ุชูุนูู ูุถุน ุงูุดูุงููุฉ: ุณุชุตูู ุฅุดุนุงุฑุงุช ุจูุจุฑุฑุงุช ุงููุฑุงุฑุงุช.");
                // Start Simulation
                startSimulation();
            } else {
                btn.style.color = 'var(--text-muted)';
            }
        }

        function showInsight(text) {
            const container = document.getElementById('insight-container');
            const bubble = document.createElement('div');
            bubble.className = 'insight-bubble';
            bubble.innerHTML = `
                <div style="color:var(--accent-gold);"><i data-lucide="info"></i></div>
                <div style="font-size:0.85rem; color:white; line-height:1.4;">${text}</div>
            `;
            container.appendChild(bubble);
            lucide.createIcons();

            // Remove after 5s
            setTimeout(() => {
                bubble.style.opacity = '0';
                bubble.style.top = '-100px';
                setTimeout(() => bubble.remove(), 500);
            }, 6000);
        }

        function startSimulation() {
            if (!explainMode) return;
            // Fake insights every 15s
            setTimeout(() => {
                if (explainMode) showInsight(`ุชุญููู: ูุงุญุธุช ุฒูุงุฏุฉ ูู ุญุฌู ุชุฏุงูู ูุทุงุน ุงูุฃุณููุช. ุฃุฑุงูุจ ุณูู ุฃุณููุช ุงูุฌููุจ.`);
                if (explainMode) startSimulation();
            }, 15000);
        }

        // --- Previously Existing Logic (Modified) ---
        async function loadStrategy(name) {
            const container = document.getElementById('content-area');
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;"> ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช ุงูุญูุฉ...</div>';

            try {
                const res = await fetch(`/api/portfolio/${encodeURIComponent(name)}`);
                const data = await res.json();

                // Mock Balance Update
                document.getElementById('cash-display').innerText = data.cash.toFixed(2) + " SAR";

                if (data.history && data.history.length > 0) {
                    container.innerHTML = data.history.slice().reverse().map(t => {
                        return `
                        <div class="trx-item ${t.action === 'BUY' ? 'buy' : 'sell'}" style="margin-bottom:10px; background:rgba(255,255,255,0.05); padding:10px;">
                            <div class="trx-details" style="flex-direction:column; gap:5px;">
                                <div style="display:flex; justify-content:space-between;">
                                    <span class="strategy-tag ${t.action === 'BUY' ? 'green' : 'red'}">${t.action}</span>
                                    <span class="symbol-text">${t.symbol}</span>
                                    <span class="trx-price">${t.price.toFixed(2)}</span>
                                </div>
                                <div style="font-size:0.85rem; color:#ccc; display:flex; align-items:center; gap:5px;">
                                    <i data-lucide="cpu" style="width:12px;"></i> ${t.reason}
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                    lucide.createIcons();
                } else {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">ุฌุงุฑู ูุณุญ ุงูุณูู... ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฑุต ุจุนุฏ.</div>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Chat & Voice Logic (Keep existing)
        function openChat() { document.getElementById('chat-modal').style.display = 'flex'; }
        async function sendMessage() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value;
            if (!txt) return;
            const hist = document.getElementById('chat-history');
            hist.innerHTML += `<div style="text-align:right; margin-bottom:10px;"><span style="background:#334155; padding:8px 12px; border-radius:15px 15px 0 15px; display:inline-block;">${txt}</span></div>`;
            inp.value = '';
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ persona: currentBot || 'General', message: txt })
                });
                const d = await res.json();
                hist.innerHTML += `<div style="text-align:left; margin-bottom:10px;"><span style="background:var(--accent-green); color:black; padding:8px 12px; border-radius:15px 15px 15px 0; display:inline-block;">${d.response}</span></div>`;
            } catch (e) { }
        }

        // Init: Check if we should auto-load dashboard (if cookie/localstorage existed, but for now reset to onboarding)
        // Default is View 1 (Onboarding)
        // switchView('onboarding'); // Already active by HTML structure
    </script>
</body>

</html>