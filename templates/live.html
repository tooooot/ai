<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Private Banking Terminal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Professional Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&family=IBM+Plex+Sans+Arabic:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bank-theme">

    <!-- Audio Consent (Professional) -->
    <div id="audio-overlay" class="audio-overlay">
        <div class="overlay-card">
            <div class="bank-logo-icon">ğŸ›ï¸</div>
            <h2>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØªÙŠ</h2>
            <p>ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø°ÙŠØ¹ Ø§Ù„Ø¢Ù„ÙŠ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©.</p>
            <button id="enable-audio-btn" class="bank-btn">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <div class="tiktok-container">

        <!-- 1. Header & Explainer -->
        <header class="bank-header">
            <div class="header-content">
                <h1 class="main-title">
                    Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠØªØ¯Ø§ÙˆÙ„ <br>
                    <span class="highlight-gold">ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</span>
                </h1>

                <!-- Smart Explainer Carousel -->
                <div class="smart-carousel">
                    <div class="carousel-track" id="explainer-track">
                        <!-- Text injected via JS -->
                        <div class="carousel-item active">ğŸ¤– Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©: 6 Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ØªØªÙ†Ø§ÙØ³ Ø£Ù…Ø§Ù…Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©</div>
                    </div>
                </div>
            </div>

            <div class="live-indicator">
                <span class="dot"></span> Ø¨Ø« Ø­ÙŠ
            </div>
        </header>

        <!-- Market Ticker (moved below header for better flow) -->
        <div class="market-ticker-wrap">
            <div class="market-ticker">
                <span>TASI: <b class="green">12,450 â–²</b></span>
                <span>OIL: <b class="green">82.40 â–²</b></span>
                <span>GOLD: <b class="red">2,350 â–¼</b></span>
                <span>AI SENTIMENT: <b class="gold">Bullish</b></span>
            </div>
        </div>

        <!-- AI Logic Terminal (Transparency Engine) -->
        <div class="logic-terminal-wrap">
            <div class="terminal-header">
                <span class="blink-dot"></span>
                LIVE AI LOGIC STREAM (v2.4 Core)
            </div>
            <div class="terminal-content" id="ai-logic-feed">
                <div class="log-line"><span class="cmd">> SYSTEM:</span> Connecting to Market Data Stream...</div>
                <div class="log-line"><span class="cmd">> CORE:</span> Loading 10 Strategy Modules...</div>
            </div>
        </div>

        <!-- Heatmap Section -->
        <div class="heatmap-wrapper">
            <div class="section-title-mini">Ø®Ø§Ø±Ø·Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø© (Market Heatmap)</div>
            <div id="market-heatmap" class="heatmap-container"></div>
        </div>

        <!-- 2. Prime Leaderboard (Top Strategies) -->
        <section class="section-title">
            <h3>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h3>
        </section>

        <section class="prime-board" id="prime-board">
            <!-- Injected via JS -->
            <div class="loading-spinner">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®ÙˆØ§Ø¯Ù…...</div>
        </section>

        <!-- 3. Real-Time Transaction Feed -->
        <section class="section-title">
            <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©</h3>
        </section>

        <div class="feed-wrapper">
            <div class="transactions-list" id="trade-feed">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- 4. Footer / Safe Zone -->
        <footer class="bank-footer">
            <div id="qrcode" class="qr-code"></div>
            <div class="footer-text">
                <p>Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ø¹Ø¨Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>
                <p class="disclaimer">Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·.</p>
            </div>
        </footer>

    </div>

    <!-- Hidden audio element for cues -->
    <audio id="alert-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"
        preload="auto"></audio>

    <script>
        // --- State ---
        let audioEnabled = false;
        let lastTradeHash = "";

        // --- Explainer Logic ---
        const explainerTexts = [
            "ğŸ¤– Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©: 6 Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØªØªÙ†Ø§ÙØ³ Ø£Ù…Ø§Ù…Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©.",
            "ğŸ“Š Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ­Ù„Ù„ Ø¨ÙŠØ§Ù†Ø§Øª 200 Ø´Ø±ÙƒØ© Ø³Ø¹ÙˆØ¯ÙŠØ© ÙÙŠ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø«Ø§Ù†ÙŠØ©.",
            "ğŸ’¡ Ù‚Ø±Ø§Ø±Ø§Øª Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ø¢Ù„ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.. Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¯Ø®Ù„ Ø¨Ø´Ø±ÙŠ.",
            "ğŸ“ˆ Ù„Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¸.. Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ø®Ù…Ø©.",
            "ğŸ›ï¸ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ù…ØªÙ†ÙˆØ¹Ø©: Ù…Ù† Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø¢Ù…Ù†."
        ];

        let currentExplainerIdx = 0;

        function rotateExplainer() {
            const track = document.getElementById('explainer-track');
            track.style.opacity = '0';

            setTimeout(() => {
                currentExplainerIdx = (currentExplainerIdx + 1) % explainerTexts.length;
                track.innerHTML = `<div class="carousel-item">${explainerTexts[currentExplainerIdx]}</div>`;
                track.style.opacity = '1';
            }, 500);
        }
        setInterval(rotateExplainer, 5000);

        // --- Interactions ---
        document.getElementById('enable-audio-btn').addEventListener('click', () => {
            const overlay = document.getElementById('audio-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 500);
            audioEnabled = true;
            speak("ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ. Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø­ÙŠØ©.", "system");
        });

        // --- Heatmap Logic ---
        let heatmapChart = null;

        function initHeatmap() {
            const options = {
                series: [{ data: [] }],
                legend: { show: false },
                chart: {
                    type: 'treemap',
                    height: 200,
                    toolbar: { show: false },
                    fontFamily: 'Tajawal, sans-serif'
                },
                title: { text: '' },
                dataLabels: {
                    enabled: true,
                    style: { fontSize: '12px', fontWeight: 'bold' },
                    formatter: function (text, op) {
                        return [text, op.value.toFixed(1) + "%"];
                    },
                    offsetY: -4
                },
                plotOptions: {
                    treemap: {
                        distributed: true,
                        enableShades: true,
                        shadeIntensity: 0.5,
                        reverseNegativeShade: true,
                        colorScale: {
                            ranges: [
                                { from: -100, to: -0.01, color: '#ef4444' }, // Red for loss
                                { from: 0, to: 100, color: '#10b981' }      // Green for profit
                            ]
                        }
                    }
                },
                theme: { mode: 'dark' },
                grid: { show: false } // Cleaner look
            };

            const el = document.querySelector("#market-heatmap");
            if (el) {
                heatmapChart = new ApexCharts(el, options);
                heatmapChart.render();
            }
        }

        function updateHeatmap(strategies) {
            if (!heatmapChart) return;

            // Map strategies to Treemap format: { x: 'Name', y: Value (Size) }
            // Note: Color is usually auto based on value in simple Treemap, 
            // but we want Size=TotalValue, Color=Return. 
            // ApexCharts basic Treemap uses one value for both size/color usually, unless custom logic.
            // Simplified Approach: Use Return% as the MAIN value (y) so size represents Performance Magnitude.
            // Or better: Use Size so big portfolios take more space.

            // For now, let's map Y to |Return| + Base so no 0 size.
            // Actually, let's use Total Value for size. And a custom color based on return logic is tricky without advanced config.
            // Let's stick to Size = Value. And we rely on the colorScale above? 
            // Wait, colorScale applies to 'y'. If y is Value (always positive), it will be all green.

            // Fix: We need custom colors per data point.
            const data = strategies.map(s => {
                const color = s.return >= 0 ? '#10b981' : '#ef4444';
                return {
                    x: s.name,
                    y: s.value, // Size based on portfolio value
                    fillColor: color // Explicit color override
                };
            });

            heatmapChart.updateSeries([{ data: data }]);
        }


        // --- Core Logic ---
        async function fetchLiveData() {
            try {
                const response = await fetch('/api/live_data');
                const data = await response.json();

                renderLeaderboard(data.leaderboard);
                renderFeed(data.recent_trades);
                renderLogicTerminal(data.leaderboard);

                // Update Heatmap
                if (!heatmapChart) initHeatmap();
                updateHeatmap(data.leaderboard);

                lucide.createIcons();

            } catch (error) {
                console.error("Data Stream Error", error);
            }
        }

        let lastProcessedLogs = {};

        function renderLogicTerminal(strategies) {
            const terminal = document.getElementById('ai-logic-feed');

            strategies.forEach(s => {
                const lastLog = s.last_log || "Initializing...";
                if (lastProcessedLogs[s.name] !== lastLog) {
                    lastProcessedLogs[s.name] = lastLog;

                    const line = document.createElement('div');
                    line.className = 'log-line';
                    line.innerHTML = `<span class="cmd">> ${s.name}:</span> ${lastLog}`;
                    terminal.appendChild(line);
                    terminal.scrollTop = terminal.scrollHeight;
                }
            });

            while (terminal.children.length > 50) {
                terminal.removeChild(terminal.firstChild);
            }
        }

        function renderLeaderboard(strategies) {
            const container = document.getElementById('prime-board');
            const sorted = [...strategies].sort((a, b) => b.return - a.return);

            container.innerHTML = sorted.map((item, index) => {
                const isPositive = item.return >= 0;
                const progressWidth = Math.min(Math.abs(item.return) * 2, 100);

                return `
                <div class="fund-row">
                    <div class="fund-rank">${index + 1}</div>
                    <div class="fund-info">
                        <div class="fund-name">${item.name}</div>
                        <div class="fund-bar-bg">
                            <div class="fund-bar-fill ${isPositive ? 'pos' : 'neg'}" style="width: ${progressWidth}%"></div>
                        </div>
                    </div>
                    <div class="fund-return ${isPositive ? 'green' : 'red'}">
                        ${isPositive ? '+' : ''}${item.return.toFixed(2)}%
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderFeed(trades) {
            const container = document.getElementById('trade-feed');

            if (trades.length > 0) {
                const latest = trades[trades.length - 1];
                const manualHash = JSON.stringify(latest);

                if (manualHash !== lastTradeHash) {
                    lastTradeHash = manualHash;
                    handleNewTrade(latest);
                }
            }

            container.innerHTML = trades.slice().reverse().slice(0, 10).map(trade => `
                <div class="trx-item ${trade.action === 'BUY' ? 'buy' : 'sell'}">
                    <div class="trx-time">${new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })}</div>
                    <div class="trx-details">
                        <span class="strategy-tag">${trade.strategy}</span>
                        <span class="action-text">${trade.action === 'BUY' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'}</span>
                        <span class="symbol-text">${trade.symbol}</span>
                    </div>
                    <div class="trx-price">${trade.price.toFixed(2)}</div>
                </div>
            `).join('');
        }

        function handleNewTrade(trade) {
            if (audioEnabled) {
                const audio = document.getElementById('alert-sound');
                audio.volume = 0.2;
                audio.play().catch(e => { });

                const action = trade.action === 'BUY' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹';
                const text = `ØµÙ†Ø¯ÙˆÙ‚ ${trade.strategy} ÙŠÙ†ÙØ° ØµÙÙ‚Ø© ${action} Ø¹Ù„Ù‰ ${trade.symbol} Ø¨Ø³Ø¹Ø± ${trade.price}`;
                speak(text, "news_anchor");
            }

            const feed = document.querySelector('.feed-wrapper');
            feed.classList.add('pulse-highlight');
            setTimeout(() => feed.classList.remove('pulse-highlight'), 1000);
        }

        function speak(text, persona) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ar-SA';
            utterance.rate = 0.9;
            utterance.pitch = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        new QRCode(document.getElementById("qrcode"), {
            text: window.location.origin + "/app",
            width: 80,
            height: 80,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });

        // Initialize
        fetchLiveData(); // Initial fetch
        setInterval(fetchLiveData, 2000);

    </script>
</body>

</html>